# Улучшенная система обработки ошибок

## Обзор

Теперь приложение показывает понятные и полезные сообщения об ошибках с подсказками о том, что нужно делать пользователю.

## Особенности

### ✅ Понятные сообщения

Вместо технических ошибок пользователи видят:

- **Заголовок** - краткое описание проблемы
- **Сообщение** - детальное объяснение
- **Действие** - что нужно сделать

### ✅ Автоматические подсказки

Система автоматически предлагает:

- **Перейти к логину** - если пользователь уже зарегистрирован
- **Перейти к регистрации** - если пользователь не найден
- **Попробовать снова** - при временных ошибках

### ✅ Автозаполнение

При переключении между формами:

- Email автоматически копируется
- Не нужно вводить заново

## Примеры ошибок

### 1. Попытка зарегистрировать существующего пользователя

**Что видит пользователь:**

```
┌─────────────────────────────────────────┐
│ ⚠️  Аккаунт уже существует              │
│                                          │
│ Пользователь с таким email уже           │
│ зарегистрирован.                         │
│                                          │
│ [Войти в существующий аккаунт] →        │
└─────────────────────────────────────────┘
```

**При нажатии на кнопку:**

- Автоматически переключается на форму входа
- Email уже заполнен
- Нужно только ввести пароль

**Код ответа бэкенда:**

```json
{
  "error": "User with this email already exists. Please login instead.",
  "error_code": "USER_ALREADY_EXISTS",
  "details": {
    "email": "user@example.com",
    "suggestion": "switch_to_login"
  }
}
```

### 2. Попытка войти с незарегистрированным email

**Что видит пользователь:**

```
┌─────────────────────────────────────────┐
│ ⚠️  Пользователь не найден               │
│                                          │
│ Аккаунт с таким email не существует.     │
│                                          │
│ [Создать новый аккаунт] →               │
└─────────────────────────────────────────┘
```

**При нажатии на кнопку:**

- Автоматически переключается на форму регистрации
- Email уже заполнен
- Нужно ввести username, имя и пароль

**Код ответа бэкенда:**

```json
{
  "error": "User with email 'user@example.com' not found. Please register first.",
  "error_code": "USER_NOT_FOUND",
  "details": {
    "email": "user@example.com",
    "suggestion": "switch_to_register"
  }
}
```

### 3. Неверный пароль

**Что видит пользователь:**

```
┌─────────────────────────────────────────┐
│ ⚠️  Неверные данные                      │
│                                          │
│ Email или пароль указаны неверно.        │
│ Проверьте правильность введённых данных. │
│                                          │
│ [Зарегистрировать новый аккаунт] →      │
└─────────────────────────────────────────┘
```

**Код ответа бэкенда:**

```json
{
  "error": "Invalid email or password. Please check your credentials.",
  "error_code": "INVALID_CREDENTIALS",
  "details": {
    "suggestion": "check_credentials"
  }
}
```

### 4. Слишком короткий пароль

**Что видит пользователь:**

```
┌─────────────────────────────────────────┐
│ ⚠️  Слишком короткий пароль              │
│                                          │
│ Пароль должен содержать минимум 6        │
│ символов.                                │
│                                          │
│ [Попробовать снова]                      │
└─────────────────────────────────────────┘
```

### 5. Слишком много попыток

**Что видит пользователь:**

```
┌─────────────────────────────────────────┐
│ ⚠️  Слишком много попыток                │
│                                          │
│ Превышен лимит запросов. Пожалуйста,     │
│ подождите несколько минут.               │
│                                          │
│ [Попробовать позже]                      │
└─────────────────────────────────────────┘
```

**Код ответа бэкенда:**

```json
{
  "error": "Too many attempts. Please try again in 60 seconds.",
  "error_code": "RATE_LIMIT_EXCEEDED",
  "details": {
    "retry_after": 60
  }
}
```

## Технические детали

### Фронтенд

#### Утилита `errorMessages.ts`

Парсит ошибки и возвращает структурированные данные:

```typescript
interface ErrorDetails {
  title: string; // Заголовок
  message: string; // Описание
  action?: string; // Текст кнопки действия
  actionType?: "switch-tab" | "retry" | "contact-support";
}

// Использование
const errorDetails = parseAuthError(error);
```

#### Компонент `AuthModal.tsx`

Отображает ошибки с помощью Chakra UI Alert:

```tsx
{
  loginError && (
    <Alert status="error" borderRadius="md">
      <AlertTitle>{loginError.title}</AlertTitle>
      <AlertDescription>{loginError.message}</AlertDescription>
      {loginError.action && (
        <Button onClick={handleAction}>{loginError.action}</Button>
      )}
    </Alert>
  );
}
```

### Бэкенд

#### Модуль `error_responses.py`

Структурированные классы ошибок:

```python
class UserAlreadyExistsError(AuthError):
    """User with this email already exists"""

    def __init__(self, email: str):
        super().__init__(
            status_code=400,
            message="User with this email already exists. Please login instead.",
            error_code="USER_ALREADY_EXISTS",
            details={"email": email, "suggestion": "switch_to_login"}
        )
```

#### Эндпоинты в `main.py`

Используют структурированные ошибки:

```python
@app.post("/api/v1/auth/register")
async def register(user_data: UserCreate):
    try:
        # ... registration logic ...
    except ValueError as e:
        if "already" in str(e).lower():
            raise UserAlreadyExistsError(user_data.email)
        # ... other error handling ...
```

## Список всех типов ошибок

### Регистрация

| Код ошибки            | HTTP | Сообщение                 | Действие  |
| --------------------- | ---- | ------------------------- | --------- |
| `USER_ALREADY_EXISTS` | 400  | Аккаунт уже существует    | Войти     |
| `INVALID_EMAIL`       | 400  | Неверный email            | Повторить |
| `WEAK_PASSWORD`       | 400  | Слишком короткий пароль   | Повторить |
| `INVALID_USERNAME`    | 400  | Неверное имя пользователя | Повторить |

### Логин

| Код ошибки                    | HTTP | Сообщение               | Действие           |
| ----------------------------- | ---- | ----------------------- | ------------------ |
| `USER_NOT_FOUND`              | 404  | Пользователь не найден  | Зарегистрироваться |
| `INVALID_CREDENTIALS`         | 401  | Неверные данные         | Проверить данные   |
| `EMAIL_CONFIRMATION_REQUIRED` | 403  | Требуется подтверждение | Проверить почту    |

### Общие

| Код ошибки            | HTTP | Сообщение             | Действие               |
| --------------------- | ---- | --------------------- | ---------------------- |
| `RATE_LIMIT_EXCEEDED` | 429  | Слишком много попыток | Подождать              |
| `AUTH_ERROR`          | 500  | Ошибка сервера        | Связаться с поддержкой |

## Преимущества

### Для пользователей

- ✅ Понятно что случилось
- ✅ Понятно что делать дальше
- ✅ Быстрое исправление ошибки (1 клик)
- ✅ Не нужно вводить данные заново

### Для разработчиков

- ✅ Структурированные ошибки
- ✅ Легко добавлять новые типы
- ✅ Единообразная обработка
- ✅ Хорошие логи

### Для поддержки

- ✅ Меньше запросов от пользователей
- ✅ Понятные коды ошибок
- ✅ Легко найти проблему
- ✅ Детальные логи на бэкенде

## Добавление новых ошибок

### Фронтенд

1. Добавьте условие в `parseAuthError()` в `errorMessages.ts`:

```typescript
// New error type
if (errorLower.includes("custom_error")) {
  return {
    title: "Новая ошибка",
    message: "Описание ошибки",
    action: "Что делать",
    actionType: "retry",
  };
}
```

### Бэкенд

1. Создайте новый класс в `error_responses.py`:

```python
class CustomError(AuthError):
    """Custom error description"""

    def __init__(self, details: str):
        super().__init__(
            status_code=400,
            message="User-friendly message",
            error_code="CUSTOM_ERROR",
            details={"info": details}
        )
```

2. Используйте в эндпоинте:

```python
@app.post("/api/v1/auth/some-endpoint")
async def some_endpoint():
    try:
        # ... logic ...
    except SomeException:
        raise CustomError("details")
```

## Тестирование

### Вручную

1. Попробуйте зарегистрироваться с существующим email
2. Попробуйте войти с несуществующим email
3. Попробуйте войти с неверным паролем
4. Попробуйте зарегистрироваться с коротким паролем

### Автоматически

```python
# backend/test_auth_flow.py
python test_auth_flow.py
```

## Заключение

Новая система обработки ошибок делает приложение более user-friendly и помогает пользователям быстро исправлять ошибки без необходимости обращаться в поддержку.

**Статус**: ✅ Готово к использованию







