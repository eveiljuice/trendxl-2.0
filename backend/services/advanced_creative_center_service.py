"""
Advanced Creative Center Discovery Service
–†–µ–∞–ª–∏–∑—É–µ—Ç —Å–ª–æ–∂–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É AI-–∞–≥–µ–Ω—Ç–∞ –¥–ª—è –ø–æ—à–∞–≥–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞ —Ö–µ—à—Ç–µ–≥–æ–≤
"""
import logging
import asyncio
import json
from typing import Dict, Any, Optional, List
import httpx
from config import settings
from .creative_center_mapping import creative_center_mapping

logger = logging.getLogger(__name__)


class AdvancedCreativeCenterService:
    """
    –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ö–µ—à—Ç–µ–≥–æ–≤ –≤ Creative Center
    —Å –ø–æ—à–∞–≥–æ–≤–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π –∏ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π
    """

    def __init__(self):
        """Initialize service with Perplexity API configuration"""
        self.api_key = settings.perplexity_api_key
        self.base_url = "https://api.perplexity.ai/chat/completions"
        self.model = settings.perplexity_model
        self.temperature = settings.perplexity_temperature
        self.max_tokens = 800  # Increased for detailed responses
        self.client = None
        self.initialized = False

        # HTTP client with timeout and retry configuration
        try:
            if self.api_key and len(self.api_key) > 20:
                self.client = httpx.AsyncClient(
                    # Increased timeout for complex operations
                    timeout=httpx.Timeout(120.0),
                    headers={
                        "Authorization": f"Bearer {self.api_key}",
                        "Content-Type": "application/json"
                    }
                )
                self.initialized = True
                logger.info("‚úÖ Advanced Creative Center service initialized")
            else:
                logger.warning("‚ö†Ô∏è Perplexity API key not configured - creative center disabled")
        except Exception as e:
            logger.error(f"‚ùå Failed to initialize Advanced Creative Center Service: {e}")
            self.initialized = False

    async def discover_hashtags_with_navigation(
        self,
        niche: str,
        country: str = "US",
        language: str = "en",
        limit: int = 10,
        auto_detect_geo: bool = False,
        profile_data: Optional[Dict[str, Any]] = None
    ) -> Dict[str, Any]:
        """
        –ì–ª–∞–≤–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ö–µ—à—Ç–µ–≥–æ–≤ —Å –ø–æ—à–∞–≥–æ–≤–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π

        –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:
        1. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≥–µ–æ–≥—Ä–∞—Ñ–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        2. –ú–∞–ø–ø–∏–Ω–≥ –Ω–∏—à–∏ –∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ Creative Center
        3. –ü–æ—à–∞–≥–æ–≤–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ Creative Center
        4. –ê–Ω–∞–ª–∏–∑ ~50 —Ö–µ—à—Ç–µ–≥–æ–≤ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        5. –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–æ —Ç–æ–ø-N —Ö–µ—à—Ç–µ–≥–æ–≤

        Args:
            niche: –ù–∏—à–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (e.g., "Tech Reviews")
            country: –ö–æ–¥ —Å—Ç—Ä–∞–Ω—ã –¥–ª—è —Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã—Ö —Ç—Ä–µ–Ω–¥–æ–≤
            language: –Ø–∑—ã–∫–æ–≤–æ–π –∫–æ–¥
            limit: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ö–µ—à—Ç–µ–≥–æ–≤ –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞
            auto_detect_geo: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≥–µ–æ–≥—Ä–∞—Ñ–∏–∏
            profile_data: –î–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≥–µ–æ–≥—Ä–∞—Ñ–∏–∏

        Returns:
            –°–ª–æ–≤–∞—Ä—å —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –ø–æ–∏—Å–∫–∞ –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏
        """
        logger.info(
            f"üöÄ Starting advanced Creative Center navigation for niche: {niche}")

        try:
            # –®–∞–≥ 1: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≥–µ–æ–≥—Ä–∞—Ñ–∏–∏ TikTok –∞–∫–∫–∞—É–Ω—Ç–∞ —á–µ—Ä–µ–∑ Perplexity
            if auto_detect_geo and profile_data:
                logger.info(
                    "üåç Analyzing TikTok account origin with Perplexity...")

                # Import perplexity service for account origin analysis
                from .perplexity_service import perplexity_service

                # Extract data for analysis
                username = profile_data.get("username", "")
                bio = profile_data.get("bio", "")
                recent_captions = profile_data.get("recent_captions", [])
                follower_count = profile_data.get("follower_count", 0)
                video_count = profile_data.get("video_count", 0)

                # Analyze account origin
                account_origin = await perplexity_service.analyze_tiktok_account_origin(
                    username=username,
                    bio=bio,
                    recent_posts_content=recent_captions,
                    follower_count=follower_count,
                    video_count=video_count
                )

                actual_country = account_origin["country_code"]
                actual_language = account_origin["language"]
                logger.info(
                    f"üåç Auto-detected TikTok account origin: {account_origin['country']} ({account_origin['confidence']} confidence)")
            else:
                actual_country = creative_center_mapping.get_country_code(
                    country)
                actual_language = language
                logger.info(f"üåç Using specified geography: {actual_country}")

            # –®–∞–≥ 2: –ú–∞–ø–ø–∏–Ω–≥ –Ω–∏—à–∏ –∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ Creative Center
            category = creative_center_mapping.map_niche_to_category(niche)
            logger.info(
                f"üìÇ Mapped niche '{niche}' to Creative Center category '{category}'")

            # –®–∞–≥ 3: –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è –ø–æ—à–∞–≥–æ–≤–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
            navigation_prompt = self._create_step_by_step_prompt(
                niche=niche,
                country=actual_country,
                language=actual_language,
                category=category,
                target_limit=limit
            )

            # –®–∞–≥ 4: –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Perplexity
            logger.info(f"üîç Executing step-by-step navigation...")
            response_text = await self._make_perplexity_request(navigation_prompt)

            # –®–∞–≥ 5: –ü–∞—Ä—Å–∏–Ω–≥ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            discovery_results = await self._parse_navigation_results(
                response_text=response_text,
                niche=niche,
                category=category,
                target_limit=limit
            )

            # –®–∞–≥ 6: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
            filtered_hashtags = await self._apply_relevance_filtering(
                hashtags=discovery_results.get('hashtags', []),
                niche=niche,
                target_limit=limit
            )

            logger.info(
                f"‚úÖ Advanced discovery completed: {len(filtered_hashtags)} final hashtags")

            return {
                "niche": niche,
                "country": actual_country,
                "language": language,
                "category": discovery_results.get('category_used', category),
                "total_found": discovery_results.get('total_analyzed', 0),
                "hashtags": filtered_hashtags,
                "navigation_success": discovery_results.get('navigation_success', True)
            }

        except Exception as e:
            logger.error(f"‚ùå Advanced Creative Center discovery failed: {e}")
            return {
                "niche": niche,
                "country": country,
                "language": language,
                "category": "Unknown",
                "total_found": 0,
                "hashtags": [],
                "navigation_success": False
            }

    def _create_step_by_step_prompt(
        self,
        niche: str,
        country: str,
        language: str,
        category: str,
        target_limit: int
    ) -> str:
        """–°–æ–∑–¥–∞–Ω–∏–µ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è –ø–æ—à–∞–≥–æ–≤–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏"""

        base_url = f"https://ads.tiktok.com/business/creativecenter/inspiration/popular/hashtag/pc/{language}"

        return f"""You are a professional TikTok Creative Center research agent. Execute this step-by-step navigation process:

## MISSION: Find the best hashtags for "{niche}" creators in {country} region

## STEP-BY-STEP NAVIGATION PROTOCOL:

### Step 1: Access Creative Center
- Navigate to: {base_url}
- Confirm you're on TikTok Creative Center hashtag inspiration page
- Verify the page loads correctly

### Step 2: Geographic Configuration
- Locate the country/region selector (usually top-right or in filters)
- Select region: {country}
- Wait for page to refresh with region-specific data
- Confirm hashtags now show {country}-specific trends

### Step 3: Category Selection  
- Find the industry/category filter menu
- Select category: "{category}"
- If "{category}" is unavailable, choose closest match from these options:
  * Technology, Fashion & Beauty, Food & Drink, Health & Fitness
  * Entertainment, Music, Education, Travel & Lifestyle, Gaming
  * Business & Finance, Arts & Crafts, Family & Parenting, Pets & Animals
- Wait for hashtags to load for selected category

### Step 4: Comprehensive Hashtag Analysis
- Study ALL hashtags displayed (typically 30-60 hashtags)
- For each hashtag, analyze:
  * Performance metrics (view counts, usage statistics)
  * Trend indicators (rising ‚Üó, stable ‚Üí, declining ‚Üò)
  * Engagement rates and growth patterns
  * Relevance to "{niche}" content specifically

### Step 5: Smart Selection Criteria
From ALL analyzed hashtags, select top {target_limit} using this priority:
1. HIGH relevance to "{niche}" (not just popular hashtags)
2. STRONG performance metrics (views, usage)
3. POSITIVE growth trends (rising preferred)
4. BALANCED mix: niche-specific + some broader appeal
5. AVOID generic tags (#fyp, #viral) unless truly dominant for this niche

### Step 6: Return Structured Data
Provide ONLY this JSON format with NO additional text:

```json
{{
  "navigation_successful": true,
  "region_confirmed": "{country}",
  "category_used": "actual_category_name_selected",
  "total_hashtags_analyzed": 47,
  "selection_methodology": "relevance + performance + growth",
  "hashtags": [
    {{
      "name": "hashtag_without_hash",
      "url": "https://ads.tiktok.com/business/creativecenter/inspiration/popular/hashtag/pc/{language}?hashtag=example",
      "volume": 1250000,
      "growth": 0.23,
      "score": 85.2,
      "relevance_score": 9.1,
      "relevance_reason": "Directly targets {niche} audience with proven engagement"
    }}
  ]
}}
```

## CRITICAL REQUIREMENTS:
- Actually browse the Creative Center interface systematically
- Use REAL data from {country} region and {category} category
- Prioritize hashtags genuinely relevant to "{niche}" creators
- Provide realistic metrics based on observed data
- Select hashtags that will help "{niche}" content get discovered

Execute this comprehensive analysis NOW for: "{niche}" in {country}"""

    async def _make_perplexity_request(self, prompt: str) -> str:
        """Execute Perplexity API request with retry logic"""
        max_retries = 3

        for attempt in range(max_retries):
            try:
                payload = {
                    "model": self.model,
                    "messages": [
                        {
                            "role": "system",
                            "content": "You are an expert TikTok Creative Center navigator with deep knowledge of social media trends, hashtag performance, and content discovery strategies. You have the ability to browse and analyze web content in real-time."
                        },
                        {
                            "role": "user",
                            "content": prompt
                        }
                    ],
                    "temperature": self.temperature,
                    "max_tokens": self.max_tokens,
                    "stream": False
                }

                logger.debug(
                    f"Making Perplexity request (attempt {attempt + 1})")

                response = await self.client.post(
                    self.base_url,
                    json=payload
                )

                if response.status_code == 200:
                    result = response.json()
                    content = result["choices"][0]["message"]["content"]
                    logger.debug("‚úÖ Perplexity request successful")
                    return content
                else:
                    logger.warning(
                        f"‚ö†Ô∏è Perplexity API error {response.status_code}: {response.text}")
                    if attempt == max_retries - 1:
                        raise Exception(
                            f"Perplexity API error: {response.status_code}")

            except Exception as e:
                logger.warning(
                    f"‚ö†Ô∏è Perplexity request attempt {attempt + 1} failed: {e}")
                if attempt == max_retries - 1:
                    raise

                # Exponential backoff
                await asyncio.sleep(2 ** attempt)

        raise Exception("Perplexity API requests exhausted")

    async def _parse_navigation_results(
        self,
        response_text: str,
        niche: str,
        category: str,
        target_limit: int
    ) -> Dict[str, Any]:
        """Parse navigation results and extract hashtag data"""

        try:
            # Extract JSON from response
            text = response_text.strip()
            start_idx = text.find('{')
            end_idx = text.rfind('}')

            if start_idx != -1 and end_idx != -1:
                json_text = text[start_idx:end_idx + 1]
                data = json.loads(json_text)

                # Extract metadata
                navigation_successful = data.get('navigation_successful', True)
                region_confirmed = data.get('region_confirmed', 'US')
                category_used = data.get('category_used', category)
                total_analyzed = data.get('total_hashtags_analyzed', 0)

                # Extract and validate hashtags
                hashtags_data = data.get('hashtags', [])
                validated_hashtags = []

                # Get more for filtering
                for item in hashtags_data[:target_limit * 2]:
                    try:
                        name = str(item.get("name", "")).lstrip("#").strip()
                        url = str(item.get("url", "")).strip()
                        volume = item.get("volume")
                        growth = item.get("growth")
                        score = item.get("score")
                        relevance_score = item.get("relevance_score", 5.0)
                        relevance_reason = item.get("relevance_reason", "")

                        # Validation
                        if name and len(name) > 1:
                            # Generate URL if not provided
                            if not url or "ads.tiktok.com" not in url:
                                url = f"https://ads.tiktok.com/business/creativecenter/inspiration/popular/hashtag/pc/en?hashtag={name}"

                            hashtag_data = {
                                "name": name,
                                "url": url,
                                "volume": volume,
                                "growth": growth,
                                "score": score,
                                "relevance_score": relevance_score,
                                "relevance_reason": relevance_reason
                            }
                            validated_hashtags.append(hashtag_data)

                    except Exception as e:
                        logger.warning(f"‚ö†Ô∏è Failed to validate hashtag: {e}")
                        continue

                logger.info(
                    f"‚úÖ Parsed {len(validated_hashtags)} hashtags from {total_analyzed} analyzed")

                return {
                    "hashtags": validated_hashtags,
                    "total_analyzed": total_analyzed,
                    "category_used": category_used,
                    "navigation_success": navigation_successful,
                    "region_confirmed": region_confirmed
                }

        except json.JSONDecodeError as e:
            logger.warning(f"‚ö†Ô∏è JSON parsing failed: {e}")
        except Exception as e:
            logger.warning(f"‚ö†Ô∏è Result parsing error: {e}")

        # Return empty results if parsing failed
        return {
            "hashtags": [],
            "total_analyzed": 0,
            "category_used": category,
            "navigation_success": False,
            "region_confirmed": "US"
        }

    async def _apply_relevance_filtering(
        self,
        hashtags: List[Dict[str, Any]],
        niche: str,
        target_limit: int
    ) -> List[Dict[str, Any]]:
        """Apply additional relevance filtering to select best hashtags"""

        if not hashtags:
            return []

        # Sort by relevance score (if available) and other metrics
        def calculate_final_score(hashtag):
            relevance_score = hashtag.get('relevance_score', 5.0)
            growth = hashtag.get('growth', 0.0) or 0.0
            score = hashtag.get('score', 50.0) or 50.0

            # Weighted scoring: relevance (40%) + growth (30%) + performance (30%)
            final_score = (relevance_score * 0.4) + \
                (growth * 100 * 0.3) + (score * 0.3)
            return final_score

        # Sort hashtags by final score
        sorted_hashtags = sorted(
            hashtags, key=calculate_final_score, reverse=True)

        # Take top N hashtags
        filtered = sorted_hashtags[:target_limit]

        logger.info(
            f"üéØ Applied relevance filtering: {len(filtered)} hashtags selected from {len(hashtags)}")

        return filtered

    async def close(self):
        """Close HTTP client"""
        await self.client.aclose()


# Global service instance
advanced_creative_center_service = AdvancedCreativeCenterService()
